# 中间件分析系统需求文档

## 项目概述

### 项目背景
公司需要分析内部网络流量，特别是针对服务集群（如MySQL集群）的客户端访问情况。基于现有的Elasticsearch索引数据，开发一套中间件分析系统，帮助运维和开发人员快速定位访问某个服务的客户端应用信息。

### 业务目标
- 快速识别访问指定服务的客户端IP
- 获取客户端主机和应用详细信息
- 提供完整的访问关系分析报告
- 支持批量服务分析和历史数据查询

## 环境和数据源

### 线上环境
- **Elasticsearch版本**: 6.1.2
- **索引格式**: 按天分割，命名规则 `sflow-yyyy.MM.dd`
- **数据量**: 每天约30G数据

### 索引数据结构
```json
{
  "_index": "sflow-2025.08.17",
  "_type": "doc",
  "_id": "EDMitJgBfqp0lJOJtSTO",
  "_score": 1,
  "_source": {
    "srcip": "10.100.6.218",           // 客户端IP
    "@timestamp": "2025-08-16T18:27:10.031Z",
    "bytes": 1522,                     // 传输字节数
    "dstip": "10.106.60.172",         // 服务端IP
    "dport": 8080,                     // 服务端端口
    "ipprotocol": 6,                   // IP协议类型
    "sport": 50843,                    // 客户端端口
    "count": 1,                        // 记录数量
    "datatype": "innerinner",          // 数据类型
    "routerip": "10.100.200.209",     // 路由器IP
    "@version": "1",
    "index_date": "2025.08.17"        // 索引日期
  }
}
```

## 功能需求

### 核心功能

#### 1. 任务提交
- **输入参数**:
  - 服务端IP列表 (ip1, ip2, ip3, ..., ipn)
  - 服务端口 (port)
  - 查询时间范围 (startDate, endDate, 格式: yyyy-MM-dd)
  - 提交人信息
  - 任务描述
- **输出**: 任务ID
- **处理方式**: 异步处理，单线程队列

#### 2. ES数据查询
- 根据服务端IP列表和端口查询ES索引
- 支持跨多天查询
- 聚合统计访问的客户端IP
- 分天查询策略，提高查询稳定性

#### 3. 外部API调用
系统需要调用以下外部API获取详细信息：

**主机信息查询API**
- 输入: clientIP, serverIP, port
- 输出: Linux路径, Client端主机名, 访问该服务的应用列表

**机器列表查询API**
- 输出: 机器名字, 内网IP, 外网IP
- 用途: 通过IP匹配获取主机名

**服务查询API**
- 输出: 服务名称, 应用负责人中文名, 应用负责人域账号, 部门
- 用途: 获取应用的详细信息

#### 4. 数据关联逻辑
```
ES查询 → 客户端IP列表
    ↓
机器列表API → IP匹配 → 主机名
    ↓
服务查询API → 应用详细信息
    ↓
最终结果: 客户端IP + 主机名 + 应用名称 + 负责人 + 部门
```

### API接口需求

#### 接口设计规范
- 使用GET参数传递，避免PathVariables
- 统一响应格式: `{"code": 100-500, "message": "", "data": object}`
- 支持分页查询和条件筛选

#### 具体接口列表
1. **POST /api/tasks** - 提交分析任务
2. **GET /api/tasks** - 任务列表查询（支持筛选和分页）
3. **GET /api/tasks/all** - 全量任务查询（按创建时间排序）
4. **GET /api/tasks/status?taskId=** - 任务状态查询
5. **GET /api/tasks/client-ips?taskId=** - 客户端IP访问结果查询
6. **GET /api/tasks/host-info?taskId=** - 完整主机和应用信息查询
7. **DELETE /api/tasks?taskId=** - 任务删除

#### 查询条件支持
- 按提交时间排序
- 按提交人筛选
- 按任务描述关键词筛选
- 分页查询支持

### 任务状态设计

#### 状态流转
```
SUBMITTED（已提交）
    ↓
ES_QUERYING（ES查询中）
    ↓
ES_COMPLETED（ES查询完成）
    ↓
API_CALLING（API调用中）
    ↓
COMPLETED（已完成） / FAILED（执行失败）
```

#### 异常处理
- **ES查询异常**: 分天重试，支持部分成功
- **API调用异常**: 跳过失败IP，继续处理其他数据
- **任务状态**: 支持部分成功状态，记录详细错误信息

### 结果展示需求
- 按实例（主机）分组展示
- 不需要统计访问量
- 不需要按部门或负责人分组
- 展示完整的访问链路信息

## 非功能需求

### 性能要求
- 支持7-30天时间范围查询
- ES查询采用分天策略避免超时
- 单线程异步处理避免系统负载

### 可用性要求
- 异常情况下系统继续处理其他数据
- 提供详细的错误日志和状态信息
- 支持任务删除（仅限已完成或失败任务）

### 扩展性要求
- 支持多种外部API接入
- 数据模型设计支持后续功能扩展
- Docker化部署，便于环境管理

## 约束条件

### 技术约束
- Elasticsearch版本限制为6.1.2
- 外部API为HTTP调用，无认证机制
- 本地开发环境需要Docker支持

### 业务约束
- 查询时间范围最大限制30天
- 单线程处理保证任务顺序执行
- 逻辑删除保证数据安全性

## 验收标准

1. **功能完整性**: 所有API接口正常工作
2. **数据准确性**: ES查询结果与实际数据一致
3. **异常处理**: 各类异常场景下系统稳定运行
4. **性能指标**: 30天数据查询在合理时间内完成
5. **文档完整性**: API文档、部署文档齐全